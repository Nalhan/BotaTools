name: Create Release

on:
  workflow_dispatch:
    inputs:
      notes:
        description: 'Release Notes'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update Version and Changelog
        id: release_prep
        run: |
          # 1. Update Version in TOC
          RAW_VER=$(grep "^## Version:" BotaTools.toc | sed -E 's/## Version:[[:space:]]*//' | xargs)
          if [[ $RAW_VER =~ ^v?([0-9]+)$ ]]; then
            VER_NUM=${BASH_REMATCH[1]}
            NEW_VER="v$((VER_NUM + 1))"
          else
            NEW_VER="v1"
          fi
          sed -i -E "s/^## Version:[[:space:]]*.*/## Version: $NEW_VER/" BotaTools.toc
          echo "new_version=$NEW_VER" >> $GITHUB_OUTPUT

          # 2. Generate Changelog
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s")
          else
            COMMITS=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD)
          fi
          
          CLEAN_COMMITS=$(echo "$COMMITS" | grep -v "Bump version" | grep -v "Merge pull request" | grep -v "Update ChangelogData" || echo "- No significant changes.")
          NEW_CHANGELOG="|cFF00FFFFBotaTools $NEW_VER|r\n\n$CLEAN_COMMITS"
          
          # 3. Handle Retention (Keep last 3 versions)
          # Extract current content of the [[ ]] block
          sed -n '/BOTA.ChangelogData = \[\[/,/\]\]/p' Data.lua | sed '1d;$d' > old_changelog.txt
          
          # Combine new and old
          echo -e "$NEW_CHANGELOG\n" > combined_changelog.txt
          cat old_changelog.txt >> combined_changelog.txt
          
          # Truncate to last 3 versions using awk
          awk '/\|cFF00FFFFBotaTools v/ {count++} count > 3 {exit} {print}' combined_changelog.txt > final_changelog.txt
          
          # Write back to Data.lua
          sed -i '/BOTA.ChangelogData = \[\[/,$d' Data.lua
          echo "BOTA.ChangelogData = [[" >> Data.lua
          cat final_changelog.txt >> Data.lua
          echo "]]" >> Data.lua

          # 4. Set output for release body (only the new version part)
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> $GITHUB_OUTPUT
          echo -e "$CLEAN_COMMITS" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add BotaTools.toc Data.lua
          git commit -m "Release ${{ steps.release_prep.outputs.new_version }} [skip ci]"
          git push

      - name: Package Addon
        run: |
          ZIP_NAME="BotaTools-${{ steps.release_prep.outputs.new_version }}.zip"
          mkdir BotaTools
          cp *.lua *.toc BotaTools/
          cp -r Modules BotaTools/
          cp -r lib BotaTools/
          zip -r "$ZIP_NAME" BotaTools/
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_prep.outputs.new_version }}
          name: Release ${{ steps.release_prep.outputs.new_version }}
          body: |
            ${{ steps.release_prep.outputs.body }}

            ## Details
            - Version: ${{ steps.release_prep.outputs.new_version }}
          files: BotaTools-${{ steps.release_prep.outputs.new_version }}.zip
          generate_release_notes: false
